# 12장. 확장성 확보에 필요한 사고방식

## **강의 31: 계층과 확장성**

### **확장성에 대한 요구**

- 하테나의 일반적인 서버 스펙: **4 Core CPU, 8GB RAM**
- 단일 서버로 처리 가능한 규모의 한계가 분명히 존재:
    - 약 **100만 PV/월** 정도까지는 단일 서버로 감당 가능
    - 고사양 서버(4 Core × 2 / 32GB RAM)라면 **200만 PV/월**까지도 가능
- 그러나 트래픽이 큰 서비스는 단일 서버 스케일업만으로는 한계가 온다. → **스케일아웃 설계** 필요

### **계층별 확장성**

핵심 메시지: **AP 서버는 수평확장 쉽고, DB·파일 저장소는 어렵다.**

### **1) AP 서버 확장**

- AP서버는 상태를 갖고 있지 않다. → **복제해서 늘리기만 하면 된다.**
- 트래픽 증가에 따라 서버 한 대 더 붙이기가 비교적 쉽게 가능한 구조이다.
- 대부분 웹 서비스가 쉽게 확장되는 이유

### **2) 데이터 소스(DB, 파일서버) 확장**

- 읽기(read) 확장은 비교적 쉽다. → 캐시·레플리카 등
- 쓰기(write) 확장은 매우 어렵다. → 데이터 정합성, 락, 트랜잭션 등
- 따라서 DB 쪽 확장 방식은 매우 신중해야 하며, 구조 자체가 병렬처리를 허용하도록 설계해야 한다.

## **강의 32: 부하 파악, 튜닝**

### **부하 파악 - 가시화된 관리 화면**

책에서는 **하테나가 실제 사용한 서버 모니터링 화면**을 예시로 보여준다.

<img width="687" height="508" alt="image" src="https://github.com/user-attachments/assets/d35886ff-74cd-464e-81f4-3c6bf8e1b74b" />

<img width="696" height="832" alt="image" src="https://github.com/user-attachments/assets/4e68a614-e5ae-4fa1-8f59-bbd3e323ba42" />

- 여러 종류의 서버(AP, backend, batch, DB 등)의 **CPU 사용량·Load Average**를 실시간 그래프로 보여준다.
- 서버별 역할(Role)이 명확하게 구분된다:
    - backend(유저용), bot(봇용), db, memcached, proxy 등
- 핵심 포인트:
    - 어떤 서버가 병목인지 한눈에 구분 가능
    - 부하가 어느 지점에서 급증하는지 발견하기 쉽다.

### **부하 측정 시 참고해야 할 항목**

1. **Load Average**
    - 아직 CPU가 할당되지 않아서 대기상태에 있는 프로세스 수의 평균치
    - 프로세스가 얼마나 밀려 있는지 표시
    - CPU 코어 수 대비 Load Average가 높으면 병목 신호
2. **메모리 사용률**
3. **CPU 사용률**
    - 단순히 높다고 나쁜 것은 아니다. CPU를 100% 활용해도 성능 저하 없으면 정상

### **용도에 맞는 튜닝 — 사용자용 서버 vs 봇 서버**

<img width="678" height="514" alt="image" src="https://github.com/user-attachments/assets/0685750f-b895-4a7c-bb58-8fabac4c1bce" />

- backend(사용자 서버)와 backend-bot(봇 처리용 서버)의 부하 패턴 비교
- 사용자 서버:
    - 트래픽이 시간대별로 강하게 출렁임
    - 급격한 피크 발생 가능
- 봇 서버:
    - 일정한 반복 패턴
    - 처리 요청량이 안정적

이 차이를 기반으로, **서버를 용도별로 분리해서 튜닝**하는 게 중요하다.

### **AP 서버 / DB 서버의 튜닝 정책과 서버 대수**

- 사용자 서버의 피크 부하를 감당하려면 **AP 서버 대수가 많아진다.**
- DB 서버도 봇, 사용자용 DB 를 나눠서 용도에 맞게 튜닝해야 한다.
- 하테나에서는 응답속도를 중요시할지, 리소스를 소진하는 것을 중요시할지로 나누고 있다.
- 부하 유형을 잘 나눠서(사용자/봇/기타) 각 계층을 독립적으로 확장하는 것이 핵심

<img width="678" height="514" alt="image" src="https://github.com/user-attachments/assets/34a8b077-3689-444f-ae57-a03babbfb780" />

### **서비스 규모와 튜닝**

- 실제 웹 서비스는 시간대별 트래픽 변화가 크다. → 간헐적 폭증 대응 필요
- 서버 대수가 늘어날 수록 비정상적인 상태를 나타내는 서버를 찾는 방법이 중요하다.
- 30대의 서버 중 1대에 이상이 발생했을 때 해당 서버를 어떻게 파악할 수 있을까가 과제다.
- 하테나에서는 서버들의 지표 그래프를 겹쳐서 1대만 비정상적인 값이 나타났을 경우에 파악하기 쉽도록 세팅해두었다.

# 12장. 확장성 확보에 필요한 사고방식 요약

- **단일 서버 스케일업은 한계가 빠르게 온다. → 계층별 스케일아웃 필수**
- **AP 서버는 수평확장이 쉽고, DB는 어렵다. → 구조적으로 분리해야 한다.**
- **부하 분석의 출발점은 Load Average, CPU·메모리·I/O 등 지표 관찰**
- **서버별 역할 분리(사용자·봇·배치)가 성능/확장성의 포인트가 될 수 있다.**
